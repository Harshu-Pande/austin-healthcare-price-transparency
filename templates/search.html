{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h2 class="mb-4">Search Medical Procedures</h2>
        <form id="searchForm" action="/search_results" method="get">
            <div class="mb-3">
                <label for="insurance" class="form-label">Insurance Plan</label>
                <select class="form-select" id="insurance" name="plan" required>
                    <option value="">Select Insurance Plan</option>
                    {% for plan in insurance_plans %}
                    <option value="{{ plan.insurance }}" data-type="{{ plan.type }}">
                        {{ plan.insurance }} {{ plan.type }}
                    </option>
                    {% endfor %}
                </select>
                <input type="hidden" id="insuranceType" name="type">
            </div>
            
            <div class="mb-3">
                <label for="procedure" class="form-label">Procedure</label>
                <input type="text" class="form-control" id="procedure" name="procedure" 
                       placeholder="Start typing procedure name or billing code" required>
                <div id="procedureList" class="list-group mt-2"></div>
            </div>
            
            <div class="mb-3">
                <label for="zipcode" class="form-label">ZIP Code</label>
                <input type="text" class="form-control" id="zipcode" name="zipcode" 
                       pattern="[0-9]{5}" placeholder="Enter 5-digit ZIP code">
            </div>
            
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const procedureInput = document.getElementById('procedure');
    const procedureList = document.getElementById('procedureList');
    const insuranceSelect = document.getElementById('insurance');
    const insuranceTypeInput = document.getElementById('insuranceType');
    let timeoutId;

    insuranceSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        insuranceTypeInput.value = selectedOption.dataset.type || '';
    });

    procedureInput.addEventListener('input', function() {
        clearTimeout(timeoutId);
        const searchTerm = this.value;
        
        if (searchTerm.length < 2) {
            procedureList.innerHTML = '';
            return;
        }

        timeoutId = setTimeout(async () => {
            const response = await fetch(`/api/procedures?plan=${insuranceSelect.value}&type=${insuranceTypeInput.value}&term=${searchTerm}`);
            const procedures = await response.json();
            
            procedureList.innerHTML = procedures.map(proc => `
                <button type="button" class="list-group-item list-group-item-action">
                    ${proc.billing_code} - ${proc.procedure_name}
                </button>
            `).join('');
        }, 300);
    });

    procedureList.addEventListener('click', function(e) {
        if (e.target.matches('button')) {
            const [code, ...nameParts] = e.target.textContent.split(' - ');
            const name = nameParts.join(' - ').trim();
            procedureInput.value = name;
            procedureList.innerHTML = '';
        }
    });

    // Validate ZIP code
    const zipcodeInput = document.getElementById('zipcode');
    zipcodeInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 5);
    });
});
</script>
{% endblock %}
